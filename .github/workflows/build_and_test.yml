name: build_and_test
on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
    types: [opened, synchronize, reopened]
  release:
    types: [created]
jobs:
  test:
    name: ${{ matrix.os }} ${{ matrix.gcrypt }} ${{ format(matrix.compiler, 'cc-') }} 
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "ubuntu-18.04", "macOS-latest", "macos-11"]
        gcrypt: ["--disable-gcrypt", ""]
        compiler: ["g{0}9", "clang{0}-8", "g{0}8", "clang{0}-7"]
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
    - name: Install Ubuntu Prerequisites
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install autoconf automake libtool pkg-config gettext libjson-c-dev flex bison libpcap-dev
        sudo apt-get install gcc-arm-linux-gnueabihf gcc-mingw-w64 libc6-dev
    - name: Configure Ubuntu compiler (GCC)
      if: startsWith(matrix.os, 'ubuntu')  && startsWith(matrix.compiler, 'g')
      run: |
        sudo apt-get install ${{ format(matrix.compiler, 'cc-') }}
        sudo apt-get install ${{ format(matrix.compiler, '++-') }}
    - name: Configure Ubuntu compiler (CLANG)
      if: startsWith(matrix.os, 'ubuntu')  && startsWith(matrix.compiler, 'c')
      run: |
        sudo apt-get install ${{ format(matrix.compiler, '') }}
        sudo apt-get install ${{ format(matrix.compiler, '++') }}
    - name: Install Ubuntu Prerequisites (libgcrypt)
      if: startsWith(matrix.os, 'ubuntu') && !startsWith(matrix.gcrypt, '--disable-gcrypt')
      run: |
        sudo apt-get install libgcrypt20-dev
    - name: Installing MacOS prerequisites
      if: startsWith(matrix.os, 'macOS')
      run: |
        brew install autoconf automake libtool pkg-config gettext json-c
    - name: Configure MacOS compiler (GCC)
      if: startsWith(matrix.os, 'macOS') && startsWith(matrix.compiler, 'g')
      run: |
        brew install ${{ format(matrix.compiler, 'cc@') }}
    - name: Install MacOS Prerequisites (libgcrypt)
      if: startsWith(matrix.os, 'macOS') && !startsWith(matrix.gcrypt, '--disable-gcrypt')
      run: |
        brew install libgcrypt
    - name: Clone nDPI
      run: |
        git clone --branch dev https://github.com/nfstream/nDPI.git
    - name: Configure nDPI (GCC) on Ubuntu
      if: startsWith(matrix.os, 'ubuntu') && startsWith(matrix.compiler, 'g')
      run: |
        cd nDPI
        env CC=${{ format(matrix.compiler, 'cc-') }} CXX=${{ format(matrix.compiler, '++-') }} CFLAGS='-Werror' ./autogen.sh --enable-debug-messages ${{ matrix.gcrypt }}
    - name: Configure nDPI (GCC) on MacOS
      if: startsWith(matrix.os, 'macOS') && startsWith(matrix.compiler, 'g')
      run: |
        ls /usr/local/bin/
        cd nDPI
        env CC=CC=/usr/local/bin/${{ format(matrix.compiler, 'cc-') }} CXX=CC=/usr/local/bin/${{ format(matrix.compiler, '++-') }} CFLAGS='-Werror' ./autogen.sh --enable-debug-messages ${{ matrix.gcrypt }}    
    - name: Configure nDPI (CLANG)
      if: startsWith(matrix.compiler, 'c')
      run: |
        cd nDPI
        env CC=${{ format(matrix.compiler, '') }} CXX=${{ format(matrix.compiler, '++') }} CFLAGS='-Werror' ./autogen.sh --enable-debug-messages ${{ matrix.gcrypt }}      
    - name: Compile nDPI
      run: |
        cd nDPI
        make all 
    - name: Test nDPI 
      run: |
        cd nDPI
        cd tests
        ./do.sh
        ./do-unit.sh
        ./do-dga.sh
    - name: Build nDPI [ARM] (runs only on ubuntu jobs)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        cd nDPI
        make distclean && env CFLAGS='-Werror' ./autogen.sh --host=arm-linux-gnueabihf --with-only-libndpi ${{ matrix.gcrypt }}
        make all
    - name: Build nDPI [Mingw-w64] (runs only on ubuntu jobs)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        cd nDPI
        make distclean && ./autogen.sh --host=x86_64-w64-mingw32 ${{ matrix.gcrypt }}
        make all
